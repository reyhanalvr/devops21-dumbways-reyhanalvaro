```
Instructions

No 5 (Deployment) app runs inside a kubernetes cluster (include frontend, backend, and database) for production Environment
Apps running 100% with backend and db integration
CICD integration for production
Ingress Nginx or others.
Domain
<name>.studentdumbways.my.id - App
api.<name>.studentdumbways.my.id - Backend API
Persistent Volume
```

# Instalasi k3s 

- Dengan bantuan Ansible kita dapat instalasi k3s dengan mudah pada cluster kita
  
```yaml
---
# tasks file for roles/kubernetes

# 1. Set hostname
- name: Set hostname for master
  hostname:
    name: "master"
  when: inventory_hostname == 'master'

- name: Set hostname for workers
  hostname:
    name: "{{ inventory_hostname }}"
  when: "'worker' in inventory_hostname"

# 2. Install K3s di master
- name: Install K3s on master
  shell: |
    curl -sfL https://get.k3s.io | sh -
  when: inventory_hostname == 'master'

# 3. Catat K3S_TOKEN dari master
- name: Get K3S token from master
  shell: cat /var/lib/rancher/k3s/server/node-token
  register: k3s_token
  changed_when: false
  when: inventory_hostname == 'master'

# 4. Dapatkan IP master
- name: Get Master IP
  ansible.builtin.command: hostname -I
  register: master_ip
  changed_when: false
  when: inventory_hostname == 'master'

# 5. Set master IP dan token sebagai fact
- name: Set master IP and token as fact
  set_fact:
    master_ip: "{{ master_ip.stdout.split()[0] }}"
    master_token: "{{ k3s_token.stdout }}"
  when: inventory_hostname == 'master'

# 6. Install K3s di worker
- name: Install K3s on workers
  shell: |
    curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars['master']['master_ip'] }}:6443 K3S_TOKEN={{ hostvars['master']['master_token'] }} sh -
  when: "'worker' in inventory_hostname"

# 7. Configure K3s di master (buat .kube, copy k3s.yaml, set permission, dan add KUBECONFIG ke .bashrc untuk user)

- name: "Create .kube directory"
  file:
    path: "/home/{{ user_name }}/.kube"
    state: directory
    mode: "0755"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
  when: inventory_hostname == 'master'

- name: "Copy k3s.yaml to the user kube config"
  ansible.builtin.command:
    cmd: "cp /etc/rancher/k3s/k3s.yaml {{ kubeconfig }}"
  args:
    creates: "{{ kubeconfig }}"
  when: inventory_hostname == 'master'

- name: "Set ownership and permissions for the kube config"
  ansible.builtin.file:
    path: "{{ kubeconfig }}"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: '0600'
  when: inventory_hostname == 'master'

- name: "Add KUBECONFIG in .bashrc as user"
  lineinfile:
    path: "/home/{{ user_name }}/.bashrc"
    line: "export KUBECONFIG={{ kubeconfig }}"
    create: yes
    state: present
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
  when: inventory_hostname == 'master'

- name: "Add KUBECONFIG in .bashrc as root"
  lineinfile:
    path: "/root/.bashrc"
    line: "export KUBECONFIG=/etc/rancher/k3s/k3s.yaml"
    create: yes
    state: present
  when: inventory_hostname == 'master'
```

![image](https://github.com/user-attachments/assets/ba1db443-6aac-42bb-9345-326ac0290d02)

# Install Helm
- Untuk menginstall helm kita bisa menggunakan cara sederhana dengan script resmi

```
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# Verifikasi Intalasi
helm version
```

## Uninstall Traefik dengan Helm

- Karena kita memakai nginx ingress nantinya, kita bisa uninstall traefik

```
sudo rm -rf /var/lib/rancher/k3s/server/manifests/traefik.yaml;
helm uninstall traefik traefik-crd -n kube-system
```

## Set Up KUBECONFIG Environment Variable
### Setup KUBECONFIG  berguna untuk memastikan kita dapat bekerja lebih efisien tanpa harus berulang kali menggunakan sudo atau mengetik k3s di depan perintah kubectl.
- Salin k3s ke home directory

```
mkdir -p ~/.kube
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $USER:$USER ~/.kube/config

```

- Set variabel KUBECONFIG agar kubectl menggunakan file konfigurasi yang benar

```
export KUBECONFIG=~/.kube/config

echo 'export KUBECONFIG=~/.kube/config' >> ~/.zshrc
source ~/.zshrc
```

## 1. Deploy Database PostgresQL

### Buat secret.yaml untuk menampung environment variable untuk deploy database

```yaml
finaltask-alvaro@master:~/apps/dumbmerch/db$ cat secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: dumbmerch
type: Opaque
stringData:
  POSTGRES_USER: 
  POSTGRES_PASSWORD: 
  POSTGRES_DB: 
```
![image](https://github.com/user-attachments/assets/dcd0c5b1-4fc5-459e-8d51-3beb57638ee7)

### Buat manifest file untuk database

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: dumbmerch
spec:
  serviceName: "postgres-svc"
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:14.5
          imagePullPolicy: IfNotPresent
          envFrom:
            - secretRef:
                name: postgres-secret
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
      volumes:
        - name: postgres-data
          persistentVolumeClaim:
            claimName: postgres-volume-claim

---

apiVersion: v1
kind: Service
metadata:
  name: postgres-svc
  namespace: dumbmerch
spec:
  type: ClusterIP
  ports:
    - port: 5432
      targetPort: 5432
  selector:
    app: postgres
```

### Periksa deployment

![image](https://github.com/user-attachments/assets/c0500eef-8972-427f-a452-eb7037fd83b8)

![image](https://github.com/user-attachments/assets/bd18f035-7660-407a-97f2-2f3cd557a8e3)

## 2. Deploy Backend

### Buat Manifest File

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: dumbmerch
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
        - name: backend
          image: registry.alvaro.studentdumbways.my.id/dumbmerch-be:1.0.0
          ports:
            - containerPort: 5000

---
apiVersion: v1
kind: Service
metadata:
  name: backend-svc
  namespace: dumbmerch
spec:
  selector:
    app: backend
  ports:
    - protocol: TCP
      port: 5000
      targetPort: 5000
  type: ClusterIP
```

## 3. Deploy Frontend

### Buat manifest file

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: dumbmerch
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: frontend
          image: registry.alvaro.studentdumbways.my.id/dumbmerch-fe:latest
          ports:
            - containerPort: 80
---

apiVersion: v1
kind: Service
metadata:
  name: frontend-svc
  namespace: dumbmerch
spec:
  selector:
    app: frontend
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
        #nodePort: 31010
  type: ClusterIP
```

# Kubernetes Ingress

### Untuk kubernetes cluster sendiri, saya memakai cert-manager untuk auto renewal sslnya

![image](https://github.com/user-attachments/assets/ec63748a-79e2-49c7-b42c-b9342cfa3f76)

![image](https://github.com/user-attachments/assets/2100adbb-2fc7-42da-bffa-3f2d4409f078)

## Install Nginx Ingress

![image](https://github.com/user-attachments/assets/1d839302-464b-4942-ab0b-70c28b2d1859)

```
# Tambahkan Repository Helm
helm repo add ingress-nginx https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/helm-chart/ingress-nginx

helm repo update

# Instal NGINX Ingress Controller
helm install nginx-ingress ingress-nginx/ingress-nginx

# Verifikasi Instalasi
kubectl get pods --namespace ingress-nginx 

```

## Buat Ingress Untuk Service

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: frontend-ingress
  namespace: dumbmerch
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  tls:
    - hosts:
        - alvaro.studentdumbways.my.id
      secretName: wildcard-tls-secret
  rules:
    - host: alvaro.studentdumbways.my.id
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend-svc
                port:
                  number: 80
  ingressClassName: nginx
```

![image](https://github.com/user-attachments/assets/923d2431-8434-4957-aaf3-897055fcb331)

# Periksa Semua Resources

![image](https://github.com/user-attachments/assets/982c40ad-a451-40a6-a377-033e83fb9dcd)

# Validasi apakah aplikasi sudah berjalan 100%

![image](https://github.com/user-attachments/assets/30d625d4-80ed-4fac-8fb6-c013e6d3256c)

![image](https://github.com/user-attachments/assets/1b1b8c95-ae87-44e1-a128-6262cde8f362)

![image](https://github.com/user-attachments/assets/4ea4e87e-5215-4ce7-847b-fb4b0be89274)

![image](https://github.com/user-attachments/assets/8e4f9ae7-e99d-4aea-8e2c-b57cf732accf)



