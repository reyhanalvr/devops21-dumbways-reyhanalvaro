Requirements

```
1 SSH keys max.
SSH Config.
Ubuntu 22.04 lts
Instructions

1. Create new user finaltask-$USER (this new user was your final tasks playground)
2. Server login with SSH key and Password
3. Create a working SSH config to log into servers
4. Only use 1 SSH keys for all purpose (Repository, CI/CD etc.)
5. UFW enabled with only used ports allowed
6. Change ssh port from (22) to (1234)
```

Pada task kali ini, kita bisa setup config dengan IaC(Ansible)
Saya membuat beberapa ansible config untuk create new user, ssh setup dan firewall ufw setup

# Ansible Create User

```yaml
---
- name: "Creating finaltask user for {{ ansible_user }}"
  ansible.builtin.user:
    name: "finaltask-{{ ansible_user }}"
    shell: /bin/bash
    create_home: true
    password: "{{ 'YourPassword' | password_hash('sha512') }}"
    state: present

- name: "Adding finaltask user to sudo group"
  ansible.builtin.user:
    name: "finaltask-{{ ansible_user }}"
    groups: sudo
    append: true
    state: present

```

![image](https://github.com/user-attachments/assets/a11b71cc-c144-465c-9660-8661b303c9c2)

# Ansible SSH Setup 

```yaml
---
# Task untuk menyalin public key SSH ke server dan mengizinkan login password
- name: Ensure SSH directory exists
  file:
    path: /home/{{ ansible_user }}/.ssh
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0700'

- name: Copy SSH public key to authorized_keys
  copy:
    src: "{{ ansible_ssh_private_key_file }}.pub"
    dest: /home/{{ ansible_user }}/.ssh/authorized_keys
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'

# Task untuk mengaktifkan login password
- name: Allow password authentication in SSH
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication yes'
  notify: Restart SSH

# Task untuk menonaktifkan root login via SSH
- name: Disable root login via SSH
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
  notify: Restart SSH

# Task untuk mengubah port SSH ke 1234
- name: Set SSH port to 1234
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Port 22'
    line: 'Port 1234'
  notify: Restart SSH

```

![image](https://github.com/user-attachments/assets/d1d38521-9872-461e-b470-023a6a6e1f3e)

# Ansible Setup Firewall

```yaml
  - name: "Enable UFW"
    community.general.ufw:
      state: enabled
      logging: 'on'

  - name: "UFW - Allow common ports for all servers"
    community.general.ufw:
      rule: allow
      port: "{{ item }}"
    loop: "{{ common_ports }}"

  - name: "UFW - Allow ports for appserver (database, backend, frontend)"
    community.general.ufw:
      rule: allow
      port: "{{ item }}"
    loop: "{{ appserver_ports }}"
    when: inventory_hostname == 'appserver-staging'

  - name: "UFW - Allow ports for gateway (webserver)"
    community.general.ufw:
      rule: allow
      port: "{{ item }}"
    loop: "{{ gateway_ports }}"
    when: inventory_hostname == 'gateway-staging'

  - name: "UFW - Allow ports for k3s master node"
    community.general.ufw:

      rule: allow
      port: "{{ item }}"
    loop: "{{ master_ports }}"
    when: inventory_hostname == 'master'

  - name: "UFW - Allow ports for k3s worker nodes"
    community.general.ufw:
      rule: allow
      port: "{{ item }}"
      proto: tcp
    loop: "{{ worker_ports }}"
    when: "'worker' in inventory_hostname"

  - name: "UFW - Allow ports for monitoring server"
    community.general.ufw:
      rule: allow
      port: "{{ item }}"
    loop: "{{ monitoring_ports }}"
    when: inventory_hostname == 'monitoring'

  - name: "Restart UFW"
    community.general.ufw:
      state: reloaded
```

![image](https://github.com/user-attachments/assets/f246540c-96ca-4474-9da9-d9698ec1e5a0)


![image](https://github.com/user-attachments/assets/6123570b-365c-4532-ab0c-26e400accad2)

## SSH CONFIG
```
Host master
    HostName 
    User finaltask-alvaro
    Port 1234
    IdentityFile /home/alvaro/.ssh/id_rsa
    IdentitiesOnly yes

Host worker-1
    HostName
    User finaltask-alvaro
    Port 1234
    IdentityFile /home/alvaro/.ssh/id_rsa
    IdentitiesOnly yes

Host worker-2
    HostName 
    User finaltask-alvaro
    Port 1234
    IdentityFile /home/alvaro/.ssh/id_rsa
    IdentitiesOnly yes

Host ci-cd
    HostName 
    User finaltask-alvaro
    Port 1234
    IdentityFile /home/alvaro/.ssh/id_rsa
    IdentitiesOnly yes

Host monitoring
    HostName 
    User finaltask-alvaro
    Port 1234
    IdentityFile /home/alvaro/.ssh/id_rsa
    IdentitiesOnly yes

Host appserver-staging
    HostName 
    User finaltask-alvaro
    Port 1234
    IdentityFile /home/alvaro/.ssh/id_rsa
    IdentitiesOnly yes

Host gateway-staging
    HostName 
    User finaltask-alvaro
    Port 1234
    IdentityFile /home/alvaro/.ssh/id_rsa
    IdentitiesOnly yes

Host docker-registry
    HostName 
    User finaltask-alvaro
    Port 1234
    IdentityFile /home/alvaro/.ssh/id_rsa
    IdentitiesOnly yes
```
