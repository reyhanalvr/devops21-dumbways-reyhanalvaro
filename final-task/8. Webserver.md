

# Auto SSL Renewal 

### Buat .env untuk menampung variable
![image](https://github.com/user-attachments/assets/3257d817-a6c6-48f2-b2e9-411526dbd591)

### Buat Bash Script 

```bash
#!/bin/bash

# ========================
# Script for Certbot Renewal with DNS-01 Challenge (Cloudflare)
# ========================

# Load configuration variables from .env file
source ./.env

LOGFILE="/var/log/certbot_renewal.log"
exec > >(tee -i $LOGFILE)
exec 2>&1


# Run the Docker container to request or renew certificates
docker run --rm \
  --name "$CONTAINER_NAME" \
  -v "$CONFIG_DIR:/etc/letsencrypt:rw" \
  "$IMAGE" certonly --dns-cloudflare \
  --dns-cloudflare-credentials "$CLOUDFLARE_INI_PATH" \
  --email "$EMAIL" \
  --agree-tos \
  --domain "$DOMAINS" \
  --non-interactive \
  --config-dir /etc/letsencrypt \
  --work-dir /etc/letsencrypt \
  --logs-dir /etc/letsencrypt

# Check if Certbot succeeded and reload Nginx to apply the new certificates
if [ $? -eq 0 ]; then
    echo "SSL certificates successfully renewed. Reloading Nginx to apply the new certificates."
    docker exec webserver-nginx-1 nginx -s reload
    if [ $? -eq 0 ]; then
        echo "Nginx successfully reloaded."
    else
        echo "Failed to reload Nginx. Please check the configuration."
    fi
else
    echo "Certbot renewal failed. Please check the logs for more details."
fi
```

- Bash Script Step
  - Script ini secara otomatis memperbarui sertifikat SSL Let's Encrypt menggunakan metode DNS-01 melalui Cloudflare.
```
1. Memuat Konfigurasi .env
2. Penulisan Log ke File certbot_renewal.log
3. Menjalankan Container untuk Certbot
4. Script akan meriksa apakah berhasil atau tidak, jika berhasil script akan mereload nginx secara otomatis
```

### Jangan lupa untuk chmod +x agar script bisa dijalankan

`sudo chmod +x ssl_renewal.sh`

### Cronjob
Jalankan Crontab editor dan pilih editor yang sesuai

```
crontab -e
```

Lalu masukkan script 

![image](https://github.com/user-attachments/assets/1a018a9f-bf30-40b8-9887-96d5f4b07e43)

Kita bisa memastikan cronjob sudah tersimpan, kamu bisa mengecek daftar cronjob dengan perintah

`crontab -l`

![image](https://github.com/user-attachments/assets/90076f9f-b14c-4573-a81d-7f0f5bf88e37)


## Penjelasan ***** (1-2-3-4-5)
1. Minute (0-59)
2. Hour (0-23)
3. Day of Month (1-31)
4. Month (1-12)
5. Day of Week (0-7)

Jadi, script auto renewal ssl akan berjalan tiap tanggal 1 di jam 12.30

# Setup Nginx

- Sebenernya kita bisa menggunakan IaC untuk setup awal nginx, tetapi saya disini coba konfigurasi secara manual untuk setup awalnya 

## Docker Compose
```yaml
services:
  nginx:
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config:/etc/nginx/conf.d
      - ./nginx.conf:/etc/nginx/nginx.conf
      - /etc/letsencrypt/live/alvaro.studentdumbways.my.id/fullchain.pem:/etc/letsencrypt/live/alvaro.studentdumbways.my.id/fullchain.pem
      - /etc/letsencrypt/live/alvaro.studentdumbways.my.id/privkey.pem:/etc/letsencrypt/live/alvaro.studentdumbways.my.id/privkey.pem
      - /etc/letsencrypt/live/staging.alvaro.studentdumbways.my.id/fullchain.pem:/etc/letsencrypt/live/staging.alvaro.studentdumbways.my.id/fullchain.pem
      - /etc/letsencrypt/live/staging.alvaro.studentdumbways.my.id/privkey.pem:/etc/letsencrypt/live/staging.alvaro.studentdumbways.my.id/privkey.pem
      - ./.htpasswd:/etc/nginx/.htpasswd
```

## Setup Konfigurasi Reverse Proxy

![image](https://github.com/user-attachments/assets/a07a2b62-0419-44a0-90ee-71c1ed1cb50b)

![image](https://github.com/user-attachments/assets/e5bf42ce-904b-4b3d-863a-4c3697f38f80)

![image](https://github.com/user-attachments/assets/25660bec-0b32-401b-91d2-04c29fdbc353)


## DNS Cloudflare Records

![image](https://github.com/user-attachments/assets/27d99a84-2f59-47d1-879d-9edaac799c7a)






